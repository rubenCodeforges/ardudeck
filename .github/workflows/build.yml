name: Build ArduDeck

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_NAME=ArduDeck-${VERSION}-linux" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev libusb-1.0-0-dev

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Rebuild native modules for Electron
        working-directory: apps/desktop
        run: npx electron-rebuild

      - name: Build Linux x64
        working-directory: apps/desktop
        run: pnpm package --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-AppImage
          path: apps/desktop/release/*.AppImage

      - name: Upload Linux deb
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-deb
          path: apps/desktop/release/*.deb

  build-mac-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_NAME=ArduDeck-${VERSION}-mac-arm64" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # Workaround for node-gyp issues on macOS
      - name: Install Python setuptools
        run: python3 -m pip install --break-system-packages setuptools || python3 -m pip install setuptools

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Rebuild native modules for Electron
        working-directory: apps/desktop
        run: npx electron-rebuild

      - name: Build macOS arm64
        working-directory: apps/desktop
        run: pnpm package --mac --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS arm64 dmg
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-dmg
          path: apps/desktop/release/*.dmg

      - name: Upload macOS arm64 zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-zip
          path: apps/desktop/release/*.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        shell: bash
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_NAME=ArduDeck-${VERSION}-win" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Rebuild native modules for Electron
        working-directory: apps/desktop
        run: npx electron-rebuild

      - name: Build Windows x64
        working-directory: apps/desktop
        run: pnpm package --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-installer
          path: apps/desktop/release/*.exe

      - name: Upload Windows portable
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_NAME }}-portable
          path: apps/desktop/release/*portable*.exe

  # Create GitHub release when a tag is pushed
  release:
    needs: [build-linux, build-mac-arm64, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -R artifacts

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          gh release create "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --draft \
            --generate-notes \
            artifacts/**/*.AppImage \
            artifacts/**/*.deb \
            artifacts/**/*.dmg \
            artifacts/**/*.zip \
            artifacts/**/*.exe
